
# Porque Active Directory?

Active Directory (AD) é um serviço de diretório para ambientes de rede Windows. É uma estrutura hierárquica distribuída que permite o gerenciamento centralizado dos recursos de uma organização, incluindo usuários, computadores, grupos, dispositivos de rede, compartilhamentos de arquivos, políticas de grupo, dispositivos e relações de confiança. O AD fornece funções de autenticação e autorização em um ambiente de domínio do Windows. Tem sofrido ataques crescentes nos últimos anos. Ele foi projetado para ser compatível com versões anteriores e muitos recursos provavelmente não são "seguros por padrão" e podem ser facilmente configurados incorretamente. Essa fraqueza pode ser aproveitada para se mover lateral e verticalmente em uma rede e obter acesso não autorizado. O AD é essencialmente um banco de dados somente leitura de tamanho considerável, acessível a todos os usuários do domínio, independentemente de seu nível de privilégio. Uma conta de usuário AD básica sem privilégios adicionais pode enumerar a maioria dos objetos no AD. Esse fato torna extremamente importante proteger adequadamente uma implementação do AD porque QUALQUER conta de usuário, independentemente de seu nível de privilégio, pode ser usada para enumerar o domínio e procurar erros de configuração e falhas minuciosamente. Além disso, vários ataques podem ser executados apenas com uma conta de usuário de domínio padrão, mostrando a importância de uma estratégia de defesa em profundidade e planejamento cuidadoso com foco na segurança e fortalecimento do AD, segmentação de rede e privilégios mínimos. Um exemplo é o ataque noPac que foi lançado pela primeira vez em dezembro de 2021.

O Active Directory torna as informações fáceis de encontrar e usar para administradores e usuários. O AD é altamente escalável, oferece suporte a milhões de objetos por domínio e permite a criação de domínios adicionais à medida que a organização cresce.

![[Pasted image 20230531220408.png]]

Estima-se que cerca de 95% das empresas da Fortune 500 executem o Active Directory, tornando o AD um foco principal para os invasores. Um ataque bem-sucedido, como um phishing que leva um invasor ao ambiente do AD como um usuário de domínio padrão, daria a ele acesso suficiente para começar a mapear o domínio e procurar caminhos de ataque. Como profissionais de segurança, encontraremos ambientes AD de todos os tamanhos ao longo de nossas carreiras. É essencial entender a estrutura e a função do AD para se tornar mais bem informado tanto como atacante quanto como defensor.

Os operadores de ransomware têm visado cada vez mais o Active Directory como uma parte fundamental de seus caminhos de ataque. O Conti Ransomware, que foi usado em mais de 400 ataques em todo o mundo, demonstrou alavancar ataques críticos recentes a falhas do Active Directory, como PrintNightmare (CVE-2021-34527) e Zerologon (CVE-2020-1472) para escalar privilégios e mover lateralmente em uma rede de destino. Compreender a estrutura e a função do Active Directory é o primeiro passo em uma carreira para encontrar e prevenir esses tipos de falhas antes que os invasores o façam. Os pesquisadores encontram continuamente novos ataques de alto risco que afetam os ambientes do Active Directory, que geralmente exigem apenas um usuário de domínio padrão para obter controle administrativo completo sobre todo o domínio. Existem muitas ótimas ferramentas de código aberto para testadores de penetração para enumerar e atacar o Active Directory. Ainda assim, para usá-los com mais eficiência, devemos entender como o Active Directory funciona para identificar falhas óbvias e sutis. As ferramentas são tão eficazes quanto o conhecimento de seu operador. Portanto, vamos reservar um tempo para entender a estrutura e a função do Active Directory antes de passar para os módulos posteriores que se concentrarão em enumeração detalhada manual e baseada em ferramentas, ataques, movimento lateral, pós-exploração e persistência.

Este módulo estabelecerá as bases para iniciar o caminho de enumerar e atacar o Active Directory. Abordaremos, em profundidade, a estrutura e a função do AD, discutiremos os vários objetos do AD, discutiremos os direitos e privilégios do usuário, ferramentas e processos para gerenciar o AD e até mesmo percorrer exemplos de configuração de um pequeno ambiente do AD.

# História do Active Directory

O LDAP, a base do Active Directory, foi introduzido pela primeira vez em RFCs já em 1971. O Active Directory foi anterior ao conceito de unidade organizacional X.500, que foi a versão mais antiga de todos os sistemas de diretório criados pela Novell e Lotus e lançada em 1993 como Novell Directory Services.

O Active Directory foi introduzido pela primeira vez em meados dos anos 90, mas não se tornou parte do sistema operacional Windows até o lançamento do Windows Server 2000. A Microsoft tentou fornecer serviços de diretório pela primeira vez em 1990 com o lançamento do Windows NT 3.0. Esse sistema operacional combinava recursos do protocolo LAN Manager e dos sistemas operacionais OS/2, que a Microsoft criou inicialmente junto com a IBM liderada por Ed Iacobucci, que também liderou o design do IBM DOS e mais tarde foi co-fundador da Citrix Systems. O sistema operacional NT evoluiu ao longo dos anos 90, adaptando protocolos como LDAP e Kerberos com elementos proprietários da Microsoft. A primeira versão beta do Active Directory foi em 1997.

O lançamento do Windows Server 2003 trouxe funcionalidade estendida e administração aprimorada e adicionou o recurso Forest, que permite aos administradores de sistema criar "contêineres" de domínios, usuários, computadores e outros objetos separados, todos sob o mesmo guarda-chuva. O Active Directory Federation Services (ADFS) foi introduzido no Server 2008 para fornecer Single Sign-On (SSO) a sistemas e aplicativos para usuários em sistemas operacionais Windows Server. O ADFS tornou mais simples e simplificado para os usuários entrarem em aplicativos e sistemas, não na mesma LAN.

O ADFS permite que os usuários acessem aplicativos além dos limites organizacionais usando um único conjunto de credenciais. O ADFS usa o modelo de autorização de controle de acesso baseado em declarações, que tenta garantir a segurança em todos os aplicativos, identificando os usuários por um conjunto de declarações relacionadas à sua identidade, que são empacotados em um token de segurança pelo provedor de identidade.

O lançamento do Server 2016 trouxe ainda mais mudanças para o Active Directory, como a capacidade de migrar ambientes AD para a nuvem e aprimoramentos adicionais de segurança, como monitoramento de acesso de usuários e contas de serviço gerenciadas por grupo (gMSA). O gMSA oferece uma maneira mais segura de executar tarefas, aplicativos e serviços automatizados específicos e geralmente é uma mitigação recomendada contra o infame ataque Kerberoasting.

2016 viu um impulso mais significativo para a nuvem com o lançamento do Azure AD Connect, que foi projetado como um método de logon único para usuários que estão sendo migrados para o ambiente do Microsoft Office 365.

O Active Directory sofreu vários erros de configuração desde 2000 até os dias atuais. Novas vulnerabilidades são descobertas regularmente e afetam o Active Directory e outras tecnologias que fazem interface com o AD, como o Microsoft Exchange.

À medida que os pesquisadores de segurança continuam descobrindo novas falhas, as organizações que executam o Active Directory precisam se manter atualizadas na correção e implementação de correções. Como testadores de penetração, temos a tarefa de encontrar essas falhas para nossos clientes antes dos invasores.

Por isso, devemos ter uma base sólida nos fundamentos do Active Directory e entender sua estrutura, função, os vários protocolos que ele usa para operar, como os direitos e privilégios do usuário são gerenciados, como os administradores de sistema administram o AD e a multiplicidade de vulnerabilidades e configurações incorretas que podem estar presentes em um ambiente AD. Gerenciar o AD não é uma tarefa fácil. Uma alteração/correção pode apresentar problemas adicionais em outro lugar. Antes de começar a enumerar e, em seguida, atacar o Active Directory, vamos abordar os conceitos fundamentais que nos acompanharão ao longo de nossas carreiras em segurança da informação.

Como dito antes, 95% das empresas da Fortune 500 executam o Active Directory, e a Microsoft tem um monopólio quase completo no espaço de serviços de diretório. Embora muitas empresas estejam fazendo a transição para ambientes de nuvem e híbridos, o AD local não vai desaparecer para muitas empresas. Se você estiver realizando testes de penetração de rede, pode ter quase certeza de encontrar o AD de alguma forma em quase todos eles.

Esse conhecimento fundamental nos tornará melhores atacantes e nos dará uma visão do AD que será extremamente útil ao fornecer conselhos de remediação aos nossos clientes. Uma compreensão profunda do AD tornará a remoção das camadas menos assustadora, e teremos a mesma confiança ao abordar um ambiente com 10.000 hosts e com um com 20.