
Vamos supor que exploramos com sucesso o sistema de destino durante o estágio de Exploração. Assim como no estágio de Exploração, devemos novamente considerar se devemos ou não utilizar Testes Evasivos no estágio Pós-Exploração. Já estamos no sistema na fase de pós-exploração, tornando muito mais difícil evitar um alerta. O estágio Pós-exploração visa obter informações confidenciais e relevantes para a segurança de uma perspectiva local e informações comerciais relevantes que, na maioria dos casos, requerem privilégios mais altos do que um usuário padrão. Esta etapa inclui os seguintes componentes:
- Evasive Testing
- Pillaging
- Privilege Escalation
- Data Exfiltration
- Information Gathering
- Vulnerability Assessment
- Persistence

![[Pasted image 20230613202607.png]]

## Evasive Testing

Se um administrador habilidoso monitorar os sistemas, qualquer alteração ou até mesmo um único comando pode disparar um alarme que nos denunciará. Em muitos casos, somos expulsos da rede e, então, a caça às ameaças começa onde somos o foco. Também podemos perder o acesso a um host (que fica em quarentena) ou a uma conta de usuário (que fica temporariamente desabilitada ou a senha alterada). Este teste de penetração teria falhado, mas teve sucesso de algumas maneiras porque o cliente poderia detectar algumas ações. Podemos agregar valor ao cliente nessa situação ainda escrevendo toda uma cadeia de ataque e ajudando-o a identificar lacunas em seu monitoramento e processos onde eles não perceberam nossas ações. Para nós, podemos estudar como e por que o cliente nos detectou e trabalhar para melhorar nossas habilidades de evasão. Talvez não tenhamos testado completamente uma carga útil ou tenhamos nos descuidado e executado um comando como net user ou whoami, que geralmente é monitorado por sistemas EDR e sinalizado como atividade anômala.

`Muitas vezes, pode ajudar nossos clientes se executarmos comandos ou ferramentas que suas defesas parem ou detectem. Isso mostra a eles que suas defesas estão trabalhando em alguns ataques. Lembre-se de que estamos emulando um invasor, portanto, nem sempre é totalmente ruim que alguns dos ataques sejam notados. Embora, ao realizar testes evasivos, nosso objetivo seja passar despercebido para que possamos identificar quaisquer "pontos cegos" que nossos clientes tenham em seus ambientes de rede.`

O teste evasivo é dividido em três categorias diferentes:
- Evasive
- Hybrid Evasive
- Non-Evasive

Isso não significa que não podemos usar todos os três métodos. Suponha que nosso cliente queira realizar um teste de penetração intrusivo para obter o máximo de informações possível e os resultados de teste mais detalhados. Nesse caso, realizaremos Testes Não Evasivos, pois as medidas de segurança em torno da rede podem nos limitar e até mesmo nos impedir. No entanto, isso também pode ser combinado com testes evasivos, usando os mesmos comandos e métodos para testes não evasivos. Podemos então ver se as medidas de segurança podem identificar e responder às ações realizadas. Nos testes Hybrid-Evasive, podemos testar componentes específicos e medidas de segurança que foram previamente definidas. Isso é comum quando o cliente deseja apenas testar departamentos ou servidores específicos para ver se eles resistem aos ataques.

## Information Gathering

Como ganhamos uma nova perspectiva sobre o sistema e a rede de nosso sistema de destino no estágio de Exploração, estamos basicamente em um novo ambiente. Isso significa que primeiro temos que nos familiarizar com o que estamos trabalhando e quais opções estão disponíveis. Portanto, na etapa Pós-Exploração, passamos novamente pelas etapas de Coleta de Informações e Avaliação de Vulnerabilidade, que podemos considerar como partes da etapa atual. Isso porque as informações que tínhamos até agora foram coletadas de uma perspectiva externa, não interna.

Do ponto de vista interno (local), temos muito mais possibilidades e alternativas para acessar determinadas informações que nos são relevantes. Portanto, a etapa de coleta de informações começa novamente a partir da perspectiva local. Pesquisamos e reunimos o máximo de informações possível. A diferença aqui é que também enumeramos a rede local e os serviços locais como impressoras, servidores de banco de dados, serviços de virtualização, etc. Frequentemente, encontraremos compartilhamentos destinados aos funcionários para troca e compartilhamento de dados e arquivos. A investigação desses serviços e componentes de rede é chamada de Pillaging.

## Pillaging

A pilhagem é o estágio em que examinamos o papel do host na rede corporativa. Analisamos as configurações de rede, incluindo, mas não limitado a:
- Interfaces
- ARP
- IP Subnets
- Routing
- Services
- Shares
- DNS
- VPN
- Network Traffic

Compreender a função do sistema em que estamos também nos dá uma excelente compreensão de como ele se comunica com outros dispositivos de rede e sua finalidade. A partir disso, podemos descobrir, por exemplo, quais subdomínios alternativos existem, se ele possui várias interfaces de rede, se existem outros hosts com os quais este sistema se comunica, se os administradores estão se conectando a outros hosts a partir dele, e se podemos potencialmente reutilizar credenciais ou roubar uma chave SSH para promover nosso acesso ou estabelecer persistência, etc. Isso ajuda, acima de tudo, a obter uma visão geral da estrutura da rede.

Por exemplo, podemos usar as políticas instaladas neste sistema para determinar o que outros hosts estão usando na rede. Porque os administradores geralmente usam esquemas específicos para proteger sua rede e impedir que os usuários alterem qualquer coisa nela. Por exemplo, suponha que descobrimos que a política de senha requer apenas oito caracteres, mas nenhum caractere especial. Nesse caso, podemos concluir que temos uma probabilidade relativamente alta de adivinhar as senhas de outros usuários neste e em outros sistemas.

Durante o estágio de pilhagem, também buscaremos dados confidenciais, como senhas em compartilhamentos, máquinas locais, scripts, arquivos de configuração, cofres de senhas, documentos (Excel, Word, arquivos .txt, etc.) e até e-mail.

Nossos principais objetivos com a pilhagem são mostrar o impacto da exploração bem-sucedida e, caso ainda não tenhamos atingido o objetivo da avaliação, encontrar dados adicionais, como senhas, que possam ser inseridos em outras etapas, como movimento lateral.

## Persistence

Assim que tivermos uma visão geral do sistema, nosso próximo passo imediato é manter o acesso ao host explorado. Dessa forma, se a conexão for interrompida, ainda podemos acessá-la. Esta etapa é essencial e frequentemente usada como a primeira etapa antes dos estágios de coleta e pilhagem de informações.

Devemos seguir sequências não padronizadas porque cada sistema é configurado individualmente por um único administrador que traz suas próprias preferências e conhecimentos. Recomenda-se que trabalhemos com flexibilidade durante esta fase e nos adaptemos às circunstâncias. Por exemplo, suponha que usamos um ataque de estouro de buffer em um serviço que provavelmente o travaria. Nesse caso, devemos estabelecer persistência no sistema o mais rápido possível para evitar ter que atacar o serviço várias vezes e potencialmente causar uma interrupção. Muitas vezes, se perdermos a conexão, não conseguiremos acessar o sistema da mesma maneira.

## Vulnerability Assessment

Se pudermos manter o acesso e ter uma boa visão geral do sistema, podemos usar as informações sobre o sistema e seus serviços e quaisquer outros dados nele armazenados para repetir a etapa de Avaliação de Vulnerabilidade, mas desta vez de dentro do sistema. Analisamos as informações e as priorizamos de acordo. O objetivo que perseguimos a seguir é a escalação de privilégios (se ainda não estiver em vigor).

Novamente, é essencial distinguir entre exploits que podem prejudicar o sistema e ataques contra os serviços que não causam nenhuma interrupção. Ao fazer isso, pesamos os componentes pelos quais já passamos na primeira etapa de Avaliação de Vulnerabilidade.

## Privilege Escalation

A escalação de privilégios é significativa e, na maioria dos casos, representa um momento crítico que pode abrir muito mais novas portas para nós. Obter os privilégios mais altos possíveis no sistema ou domínio geralmente é crucial. Portanto, queremos obter os privilégios do root (em sistemas baseados em Linux) ou o administrador de domínio/administrador local/SISTEMA (em sistemas baseados em Windows), porque isso geralmente nos permite mover por toda a rede sem quaisquer restrições.

No entanto, é importante lembrar que nem sempre a escalação de privilégios precisa ocorrer localmente no sistema. Também podemos obter credenciais armazenadas durante o estágio de coleta de informações de outros usuários que são membros de um grupo privilegiado superior. Explorar esses privilégios para efetuar login como outro usuário também faz parte do escalonamento de privilégios porque escalamos nossos privilégios (rapidamente) usando o novo conjunto de credenciais.

## Data Exfiltration

Durante a fase de Coleta e Pilhagem de Informações, muitas vezes poderemos encontrar, entre outras coisas, informações pessoais consideráveis ​​e dados de clientes. Alguns clientes vão querer verificar se é possível exfiltrar esses tipos de dados. Isso significa que tentamos transferir essas informações do sistema de destino para o nosso. Sistemas de segurança como Data Loss Prevention (DLP) e Endpoint Detection and Response (EDR) ajudam a detectar e prevenir a exfiltração de dados. Além do monitoramento de rede, muitas empresas usam criptografia em discos rígidos para impedir que terceiros visualizem essas informações. Antes de exfiltrar quaisquer dados reais, devemos verificar com o cliente e nosso gerente. Muitas vezes, pode ser suficiente criar alguns dados falsos (como números de cartão de crédito falsos ou números de previdência social) e exfiltrá-los em nosso sistema. Dessa forma, os mecanismos de proteção que procuram padrões nos dados que saem da rede serão testados, mas não seremos responsáveis ​​por nenhum dado sensível ao vivo em nossa máquina de teste.

As empresas devem aderir aos regulamentos de segurança de dados, dependendo do tipo de dados envolvidos. Estes incluem, mas não estão limitados a:

- Credit Card Account Information: Payment Card Industry (PCI)
- Electronic Patient Health Information: Health Insurance Portability and Accountability Act (HIPAA)
- Consumers Private Banking Information: Gramm-Leach-Bliley (GLBA)
- Government Information: Federal Information Security Management Act of 2002 (FISMA)

Algumas estruturas que as empresas podem seguir incluem:
- NIST
- ISO
- GDPR
- FEDRAMP
- CIS CONTROLS
- PCI-DSS
- COBIT
- ITAR
- AICPA
- NERP CIP STANDARDS

Vale a pena nos familiarizarmos com cada uma dessas estruturas, mas o que é crucial para nós, no entanto, é como lidamos com essas informações. Para nós, o tipo de dados não tem muito significado, mas os controles necessários em torno dele sim e, como afirmado anteriormente, podemos simular a exfiltração de dados da rede como uma prova de conceito de que isso é possível. Devemos verificar com o cliente para garantir que seus sistemas sejam destinados a capturar o tipo de dados falsos que tentamos exfiltrar se formos bem-sucedidos, para que não deturpemos nada em nosso relatório.

É um bom hábito executar uma gravação de tela (junto com capturas de tela) como evidência adicional para essas etapas vitais. Se tivermos apenas acesso ao terminal, podemos exibir o nome do host, Endereço IP, nome de usuário e o caminho correspondente para o arquivo do cliente e faça uma captura de tela ou captura de tela. Isso nos ajuda a provar a origem dos dados e que podemos removê-los do ambiente com sucesso.

Se dados sensíveis como este forem encontrados, nosso cliente deve, é claro, ser informado imediatamente. Com base no fato de que podemos aumentar os privilégios e exfiltrar dados pessoais, eles podem querer pausar, encerrar, ou mudar o foco do teste de penetração, especialmente se a exfiltração de dados for o objetivo principal. No entanto, isso fica a critério do nosso cliente, e muitos preferem que continuemos testando para identificar todos os possíveis pontos fracos em seu ambiente.

